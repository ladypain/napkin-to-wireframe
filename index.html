<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Wireframes Avanzado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/5.0.0/gridstack-all.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/5.0.0/gridstack.min.css" rel="stylesheet"/>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .canvas-wrapper { display: flex; gap: 20px; margin-top: 20px; }
        .canvas-container { flex: 1; background: white; border: 1px solid #ccc; border-radius: 4px; }
        .tools { margin-bottom: 10px; }
        button { padding: 8px 16px; margin-right: 10px; cursor: pointer; }
        #message { padding: 10px; margin: 10px 0; border-radius: 4px; display: none; }
        .grid-stack-item-content { background: white; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <div id="opencv-status">OpenCV: Cargando...</div>
    <div class="container">
        <h1>Creador de Wireframes Avanzado</h1>
        <div class="tools">
            <button onclick="toggleDrawingMode()">Modo Dibujo</button>
            <button onclick="clearCanvases()">Limpiar</button>
            <button onclick="interpretWireframe()">Interpretar</button>
            <button onclick="downloadWireframe()">Descargar</button>
        </div>
        <div id="message"></div>
        <div class="canvas-wrapper">
            <div class="canvas-container">
                <canvas id="drawing-canvas" width="600" height="400"></canvas>
            </div>
            <div class="canvas-container" id="refined-container">
                <div class="grid-stack"></div>
            </div>
        </div>
    </div>

    <script>
        let drawingCanvas, grid, isDrawingMode = true;

        function initializeCanvases() {
            drawingCanvas = new fabric.Canvas('drawing-canvas', {
                isDrawingMode: true,
                backgroundColor: 'white'
            });
            drawingCanvas.freeDrawingBrush.width = 2;
            drawingCanvas.freeDrawingBrush.color = "#000000";
        
            grid = GridStack.init({
                column: 12,
                row: 6,
                cellHeight: 60,
                acceptWidgets: true,
                disableOneColumnMode: true,
            }, '#refined-container .grid-stack');
            
            console.log("Canvases inicializados");
        }

        function showMessage(text, isSuccess = true) {
            const message = document.getElementById('message');
            message.style.display = 'block';
            message.style.backgroundColor = isSuccess ? '#e8f5e9' : '#ffebee';
            message.style.color = isSuccess ? '#2e7d32' : '#c62828';
            message.textContent = text;
            setTimeout(() => message.style.display = 'none', 3000);
        }

        function interpretWireframe() {
            console.log("Iniciando interpretación del wireframe");
            const dataUrl = drawingCanvas.toDataURL();
            console.log("DataURL generado");
            const img = new Image();
            img.onload = function() {
                console.log("Imagen cargada");
                const mat = cv.imread(img);
                console.log("Matriz creada");
                const elements = detectElements(mat);
                console.log("Elementos detectados:", elements);
                displayRefinedWireframe(elements);
                mat.delete();
            };
            img.onerror = function() {
                console.error("Error al cargar la imagen");
            };
            img.src = dataUrl;
        }

        function detectElements(mat) {
            console.log("Detectando elementos");
            const elements = [];
            let gray = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
        
            cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
            cv.threshold(gray, gray, 150, 255, cv.THRESH_BINARY_INV);
            cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
        
            console.log("Número de contornos encontrados:", contours.size());
        
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);
                if (area > 100) {  // Filtrar contornos pequeños
                    let rect = cv.boundingRect(cnt);
                    let element = interpretElement(rect, mat);
                    elements.push(element);
                }
                cnt.delete();
            }
        
            gray.delete();
            contours.delete();
            hierarchy.delete();
        
            console.log("Elementos detectados:", elements);
            return elements;
        }

        function interpretElement(rect, mat) {
            const aspectRatio = rect.width / rect.height;
            if (aspectRatio > 1.5) {
                return { type: 'input', rect: rect };
            } else if (Math.abs(aspectRatio - 1) < 0.2 && rect.width < 50) {
                return { type: 'checkbox', rect: rect };
            } else if (rect.width < 50 && rect.height < 50) {
                // Verificar si es un radio button (círculo)
                let center = new cv.Point(rect.x + rect.width / 2, rect.y + rect.height / 2);
                let result = cv.minEnclosingCircle(mat.roi(rect));
                if (result.radius > 0 && result.radius < rect.width / 2) {
                    return { type: 'radio', rect: rect };
                }
            }
            return { type: 'label', rect: rect };
        }

        function displayRefinedWireframe(elements) {
            console.log("Mostrando wireframe refinado");
            grid.removeAll();
            elements.forEach((elem, index) => {
                console.log("Procesando elemento:", elem);
                let content = '';
                switch(elem.type) {
                    case 'input':
                        content = '<input type="text" style="width: 100%;">';
                        break;
                    case 'checkbox':
                        content = '<input type="checkbox">';
                        break;
                    case 'radio':
                        content = '<input type="radio" name="group1">';
                        break;
                    case 'label':
                        content = 'Label';
                        break;
                }
                grid.addWidget({x: elem.rect.x / 50, y: elem.rect.y / 50, w: Math.max(1, elem.rect.width / 50), h: Math.max(1, elem.rect.height / 50), content: content});
            });
            console.log("Wireframe refinado mostrado");
        }

        function toggleDrawingMode() {
            isDrawingMode = !isDrawingMode;
            drawingCanvas.isDrawingMode = isDrawingMode;
            showMessage(isDrawingMode ? 'Modo dibujo activado' : 'Modo selección activado');
        }

        function clearCanvases() {
            drawingCanvas.clear();
            drawingCanvas.backgroundColor = 'white';
            grid.removeAll();
            showMessage('Canvases limpiados');
        }

        function downloadWireframe() {
            html2canvas(document.querySelector("#refined-container")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'wireframe.png';
                link.href = canvas.toDataURL();
                link.click();
            });
            showMessage('Wireframe descargado');
        }

        window.onload = function() {
            initializeCanvases();
            cv['onRuntimeInitialized'] = function() {
                document.getElementById('opencv-status').textContent = 'OpenCV: Listo';
                console.log('OpenCV ready');
            };
        };
    </script>
    <script async src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
